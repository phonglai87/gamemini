<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER BREACH: PROTOCOL 2099</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        :root {
            --primary: #0f0;
            --secondary: #00ffea;
            --alert: #ff0055;
            --dark: #050505;
            --glass: rgba(0, 20, 0, 0.7);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Share Tech Mono', monospace;
            color: var(--primary);
            user-select: none;
        }

        /* MATRIX RAIN CANVAS */
        #matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 0;
            opacity: 0.3;
        }

        /* CRT SCANLINE EFFECT */
        .crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 100;
        }

        /* MAIN CONTAINER */
        #game-interface {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; max-width: 1000px;
            height: 80vh;
            z-index: 10;
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 20px;
            padding: 20px;
            background: var(--glass);
            border: 1px solid var(--primary);
            box-shadow: 0 0 20px var(--primary), inset 0 0 50px rgba(0,255,0,0.2);
            backdrop-filter: blur(5px);
        }

        /* TRÁI: MA TRẬN */
        .matrix-panel {
            display: flex;
            flex-direction: column;
            border-right: 2px solid var(--primary);
            padding-right: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--primary);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 0 0 10px var(--primary);
        }

        #grid-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            flex-grow: 1;
        }

        .cell {
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid rgba(0, 255, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .cell:hover {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 15px var(--primary);
        }

        .cell.active-row::after, .cell.active-col::after {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            background: rgba(0, 255, 234, 0.1);
            pointer-events: none;
        }
        
        .cell.disabled {
            color: #333;
            border-color: #333;
            pointer-events: none;
            background: transparent;
        }

        .cell.selected {
            background: #000;
            color: var(--primary);
            border: 1px solid var(--primary);
            box-shadow: inset 0 0 10px var(--primary);
        }

        /* PHẢI: INFO & TARGET */
        .info-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .target-sequence {
            border: 1px dashed var(--secondary);
            padding: 15px;
            background: rgba(0, 50, 50, 0.5);
        }

        .seq-title {
            color: var(--secondary);
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .seq-display {
            display: flex;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
        }

        .buffer-display {
            border: 1px solid var(--alert);
            padding: 15px;
            min-height: 50px;
            display: flex;
            gap: 10px;
            color: var(--alert);
            font-size: 20px;
        }

        .timer-box {
            font-size: 40px;
            text-align: right;
            color: var(--alert);
        }

        /* MODAL */
        #modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .glitch-text {
            font-size: 60px;
            font-weight: bold;
            position: relative;
            text-shadow: 2px 2px var(--alert), -2px -2px var(--secondary);
            animation: glitch 1s infinite;
        }

        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }

        button {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 15px 40px;
            font-family: 'Share Tech Mono';
            font-size: 24px;
            cursor: pointer;
            margin-top: 30px;
            transition: 0.3s;
        }
        button:hover {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 30px var(--primary);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #game-interface { grid-template-columns: 1fr; height: 95vh; }
            .matrix-panel { border-right: none; border-bottom: 1px solid var(--primary); }
            #grid-container { height: 300px; }
        }
    </style>
</head>
<body>

    <div class="crt-overlay"></div>
    <canvas id="matrix-bg"></canvas>

    <div id="game-interface">
        <div class="matrix-panel">
            <div class="header">
                <span>BREACH PROTOCOL_</span>
                <span>LVL: <span id="level">1</span></span>
            </div>
            <div id="grid-container"></div>
            <div style="margin-top: 10px; font-size: 12px; color: #888;">
                > HƯỚNG DẪN: CHỌN HÀNG NGANG -> CHỌN CỘT DỌC -> LẶP LẠI
            </div>
        </div>

        <div class="info-panel">
            <div class="timer-box" id="timer">60.00</div>
            
            <div class="target-sequence">
                <div class="seq-title">MÃ CẦN TÌM (TARGET)</div>
                <div class="seq-display" id="target-seq">
                    </div>
            </div>

            <div class="buffer-box">
                <div class="seq-title">BỘ ĐỆM (BUFFER)</div>
                <div class="buffer-display" id="player-buffer">
                    </div>
            </div>

            <div style="margin-top: auto; font-size: 12px;">
                STATUS: <span id="status-text" style="color: var(--secondary)">CONNECTED</span><br>
                ENCRYPTION: <span style="color: var(--alert)">HIGH</span>
            </div>
        </div>
    </div>

    <div id="modal">
        <div class="glitch-text" id="modal-title">SYSTEM HACK</div>
        <div id="modal-msg" style="font-size: 20px; margin-top: 20px;">INITIATE SEQUENCE?</div>
        <button onclick="startGame()">KHỞI CHẠY (START)</button>
    </div>

    <script>
        // --- ÂM THANH (Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'hover') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.05, now);
                osc.start(now);
                osc.stop(now + 0.05);
            } else if (type === 'click') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'success') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.linearRampToValueAtTime(880, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'fail') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.2, now);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // --- MATRIX RAIN EFFECT ---
        const canvas = document.getElementById('matrix-bg');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレゲゼデベペオォコソトノホモヨョロヲゴゾドボポ1234567890ABCDEF';
        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);

        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#0F0';
            ctx.font = fontSize + 'px monospace';

            for (let i = 0; i < drops.length; i++) {
                const text = katakana.charAt(Math.floor(Math.random() * katakana.length));
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }
        setInterval(drawMatrix, 30);

        // --- GAME LOGIC ---
        const GRID_SIZE = 6;
        const HEX_CODES = ['1C', '55', 'BD', 'E9', '7A', 'FF'];
        
        let level = 1;
        let score = 0;
        let gridData = [];
        let targetSeq = [];
        let playerSeq = [];
        let timerInterval;
        let timeLeft = 60;
        let isRowTurn = true; // Bắt đầu bằng chọn Hàng
        let activeIndex = 0; // Index của hàng hoặc cột đang active

        function generateGrid() {
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            gridData = [];

            // Tạo dữ liệu ngẫu nhiên
            for(let r=0; r<GRID_SIZE; r++) {
                let row = [];
                for(let c=0; c<GRID_SIZE; c++) {
                    const code = HEX_CODES[Math.floor(Math.random() * HEX_CODES.length)];
                    row.push({ code, r, c, used: false });
                }
                gridData.push(row);
            }

            // Tạo Target Sequence (Logic thông minh: đảm bảo target có thể giải được)
            // Đơn giản hóa: Random 3-4 code cho level 1
            const length = 2 + level;
            targetSeq = [];
            // Giả lập đường đi để tạo Target khả thi
            let tempR = 0, tempC = 0; // Bắt đầu mặc định dòng 0
            let isRow = true;
            for(let i=0; i<length; i++) {
                // Đây là logic đơn giản, thực tế cần pathfinding
                targetSeq.push(HEX_CODES[Math.floor(Math.random() * HEX_CODES.length)]); 
            }
            
            renderGrid();
            renderTarget();
            highlightAvailable(true, 0); // Bắt đầu ở hàng 0
        }

        function renderGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            
            gridData.forEach((row, r) => {
                row.forEach((cell, c) => {
                    const el = document.createElement('div');
                    el.className = 'cell';
                    el.innerText = cell.code;
                    el.dataset.r = r;
                    el.dataset.c = c;
                    
                    el.addEventListener('mouseover', () => {
                        if(!cell.used && isValidMove(r, c)) playSound('hover');
                    });
                    
                    el.addEventListener('click', () => handleClick(r, c));
                    container.appendChild(el);
                });
            });
        }

        function renderTarget() {
            const div = document.getElementById('target-seq');
            div.innerHTML = targetSeq.map(code => `<span>${code}</span>`).join('');
            document.getElementById('player-buffer').innerHTML = '';
            playerSeq = [];
        }

        // Highlight Hàng hoặc Cột được phép chọn
        function highlightAvailable(isRow, index) {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(el => {
                el.classList.remove('active-row', 'active-col');
                // Reset opacity
                if (!el.classList.contains('disabled')) el.style.opacity = 0.3;
            });

            isRowTurn = isRow;
            activeIndex = index;

            cells.forEach(el => {
                const r = parseInt(el.dataset.r);
                const c = parseInt(el.dataset.c);
                const cellData = gridData[r][c];

                if (cellData.used) return;

                if ((isRow && r === index) || (!isRow && c === index)) {
                    el.classList.add(isRow ? 'active-row' : 'active-col');
                    el.style.opacity = 1;
                    el.style.cursor = 'pointer';
                } else {
                    el.style.cursor = 'not-allowed';
                }
            });
        }

        function isValidMove(r, c) {
            if (gridData[r][c].used) return false;
            if (isRowTurn && r === activeIndex) return true;
            if (!isRowTurn && c === activeIndex) return true;
            return false;
        }

        function handleClick(r, c) {
            if (!isValidMove(r, c)) {
                playSound('fail');
                return;
            }

            playSound('click');
            
            // Logic chọn ô
            const cellData = gridData[r][c];
            cellData.used = true;
            
            // Update UI ô đã chọn
            const cells = document.querySelectorAll('.cell');
            const el = Array.from(cells).find(e => e.dataset.r == r && e.dataset.c == c);
            el.classList.add('selected');
            el.classList.add('disabled');
            el.innerText = '[]'; // Hiệu ứng biến mất code

            // Thêm vào Buffer
            playerSeq.push(cellData.code);
            updateBufferUI();

            // Kiểm tra thắng thua
            checkWinCondition();

            // Chuyển lượt (Hàng -> Cột -> Hàng)
            // Nếu vừa chọn Hàng (isRowTurn = true), thì lượt sau chọn Cột tại vị trí C vừa click
            highlightAvailable(!isRowTurn, isRowTurn ? c : r);
        }

        function updateBufferUI() {
            const div = document.getElementById('player-buffer');
            div.innerHTML = playerSeq.map(code => `<span>${code}</span>`).join('');
        }

        function checkWinCondition() {
            // Chuyển array thành string để so sánh
            const targetStr = targetSeq.join('');
            const playerStr = playerSeq.join('');

            // Kiểm tra nếu buffer chứa target (người chơi có thể bấm sai vài lần đầu nhưng đúng chuỗi sau)
            if (playerStr.includes(targetStr)) {
                endGame(true);
            } else if (playerSeq.length >= targetSeq.length + 2) { // Buffer đầy (cho sai tối đa 2 lần)
                endGame(false);
            }
        }

        function startGame() {
            document.getElementById('modal').style.display = 'none';
            level = 1;
            timeLeft = 60;
            document.getElementById('level').innerText = level;
            generateGrid();
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                document.getElementById('timer').innerText = timeLeft.toFixed(2);
                if (timeLeft <= 0) endGame(false);
            }, 100);
            
            playSound('success');
        }

        function nextLevel() {
            level++;
            timeLeft += 30; // Thưởng thời gian
            document.getElementById('level').innerText = level;
            generateGrid();
            document.getElementById('modal').style.display = 'none';
            playSound('success');
        }

        function endGame(isWin) {
            if (isWin) {
                playSound('success');
                document.getElementById('modal-title').innerText = "ACCESS GRANTED";
                document.getElementById('modal-title').style.color = "#0f0";
                document.getElementById('modal-msg').innerText = "UPLOAD COMPLETE. NEXT SERVER?";
                document.querySelector('#modal button').innerText = "NEXT LEVEL";
                document.querySelector('#modal button').onclick = nextLevel;
                document.getElementById('modal').style.display = 'flex';
            } else {
                playSound('fail');
                clearInterval(timerInterval);
                document.getElementById('modal-title').innerText = "SYSTEM LOCKDOWN";
                document.getElementById('modal-title').style.color = "#f00";
                document.getElementById('modal-msg').innerText = "CONNECTION TRACED. REBOOT SYSTEM.";
                document.querySelector('#modal button').innerText = "RETRY";
                document.querySelector('#modal button').onclick = startGame;
                document.getElementById('modal').style.display = 'flex';
            }
        }
        
        // Resize canvas khi đổi kích thước màn hình
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

    </script>
</body>
</html>