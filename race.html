<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON RACER V2: INTERPLANETARY</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Orbitron', sans-serif;
            color: #fff;
            user-select: none;
        }

        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* HUD & UI */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px; box-sizing: border-box;
        }

        .hud-top { display: flex; justify-content: space-between; text-shadow: 0 0 10px #0ff; }
        .info-box { background: rgba(0,0,0,0.5); padding: 10px; border: 1px solid #0ff; transform: skewX(-15deg); }
        .planet-name { font-size: 28px; color: #ff00de; font-weight: bold; }
        
        .center-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; display: none; pointer-events: auto;
        }

        /* ĐÈN GIAO THÔNG / COUNTDOWN */
        #countdown-layer {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            display: none; text-align: center;
        }
        .light-row { display: flex; gap: 20px; justify-content: center; margin-bottom: 20px; }
        .traffic-light {
            width: 60px; height: 60px; border-radius: 50%; background: #333;
            box-shadow: 0 0 10px #000 inset; transition: all 0.1s; border: 2px solid #555;
        }
        .light-red { background: #ff0000; box-shadow: 0 0 50px #ff0000; }
        .light-green { background: #00ff00; box-shadow: 0 0 50px #00ff00; }
        #countdown-text { font-size: 80px; font-weight: 900; color: #fff; text-shadow: 0 0 20px #fff; }

        /* Nút bấm */
        .btn {
            background: linear-gradient(45deg, #0ff, #00f); border: none; padding: 15px 40px;
            font-family: 'Orbitron'; font-size: 20px; color: white; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 0 20px #0ff;
            clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%);
        }
        .btn:hover { background: linear-gradient(45deg, #fff, #0ff); color: #000; }

        /* Scanlines & Vignette */
        .overlay {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 10;
            background: radial-gradient(circle, transparent 50%, #000 150%);
        }
        .scanlines {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; opacity: 0.6;
        }

        /* Warp Effect */
        #warp-screen {
            position: absolute; top:0; left:0; width:100%; height:100%; background: white;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 1s;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <div class="scanlines"></div>
    <div class="overlay"></div>
    <div id="warp-screen"></div>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="info-box">
                <div>DESTINATION</div>
                <div id="planet-display" class="planet-name">NEO-TOKYO</div>
            </div>
            <div class="info-box" style="text-align: right;">
                <div>DISTANCE TO JUMP</div>
                <div style="font-size: 24px; color: #0ff;"><span id="dist-remain">1000</span> KM</div>
            </div>
        </div>

        <div id="start-screen" class="center-msg" style="display: block;">
            <h1 style="font-size: 50px; text-shadow: 0 0 30px #f0f;">NEON RACER<br>INTERPLANETARY</h1>
            <p>Sẵn sàng du hành vũ trụ chưa?</p>
            <button class="btn" onclick="startSequence()">KHỞI ĐỘNG XE</button>
        </div>

        <div id="game-over-screen" class="center-msg">
            <h1 style="color: red; text-shadow: 0 0 20px red;">MISSION FAILED</h1>
            <p>Xe đã bị phá hủy.</p>
            <button class="btn" onclick="resetGame()">THỬ LẠI</button>
        </div>
        
        <div id="countdown-layer">
            <div class="light-row">
                <div id="l1" class="traffic-light"></div>
                <div id="l2" class="traffic-light"></div>
                <div id="l3" class="traffic-light"></div>
            </div>
            <div id="countdown-text">READY</div>
        </div>
    </div>

    <div id="game-container"></div>

    <script>
        // --- CẤU HÌNH ---
        const CONFIG = {
            laneWidth: 3.5,
            baseSpeed: 0.8,
            maxSpeed: 2.0,
            levelDistance: 2000 // Khoảng cách để qua màn
        };

        // --- DỮ LIỆU CÁC HÀNH TINH (LEVELS) ---
        const LEVELS = [
            { name: "NEO-TOKYO", color: 0x00ffff, fog: 0x0a001a, ground: 0x110022 },
            { name: "MARS OUTPOST", color: 0xff4400, fog: 0x220500, ground: 0x331100 },
            { name: "ICE PLANET", color: 0x0088ff, fog: 0x001133, ground: 0x002244 },
            { name: "VOID SECTOR", color: 0xaa00ff, fog: 0x1a0022, ground: 0x110011 }
        ];

        let scene, camera, renderer;
        let player, roadMesh, planetMesh;
        let buildings = [], obstacles = [], stars;
        let gameActive = false;
        let levelIndex = 0;
        let distanceTraveled = 0;
        let speed = 0;
        let currentLane = 0;
        let targetX = 0;
        let isBoosting = false;

        function init() {
            scene = new THREE.Scene();
            
            // Camera
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 4, 8);
            camera.lookAt(0, 0, -20);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('game-container').appendChild(renderer.domElement);

            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // Game Objects
            createEnvironment(); // Road, Buildings, Sky
            createPlayer();
            
            // Set level đầu tiên
            applyLevelTheme(0);

            // Listeners
            window.addEventListener('resize', onResize);
            document.addEventListener('keydown', handleInput);
            document.addEventListener('keyup', (e) => { if(e.code === 'Space') isBoosting = false; });
            
            animate();
        }

        // --- TẠO MÔI TRƯỜNG ---
        function createEnvironment() {
            // 1. Con đường (Road)
            const roadGeo = new THREE.PlaneGeometry(40, 400);
            // Tạo texture sọc bằng Canvas
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#111'; ctx.fillRect(0,0,512,512);
            // Vẽ làn đường
            ctx.fillStyle = '#333'; 
            ctx.fillRect(250, 0, 12, 512); // Vạch giữa
            ctx.fillStyle = '#fff';
            ctx.fillRect(10, 0, 10, 512); // Lề trái
            ctx.fillRect(492, 0, 10, 512); // Lề phải
            
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(1, 20); // Lặp lại texture

            const roadMat = new THREE.MeshStandardMaterial({ 
                map: texture, 
                roughness: 0.8 
            });
            roadMesh = new THREE.Mesh(roadGeo, roadMat);
            roadMesh.rotation.x = -Math.PI / 2;
            roadMesh.position.z = -100;
            roadMesh.receiveShadow = true;
            scene.add(roadMesh);

            // 2. Hành tinh nền (Background Planet)
            const planetGeo = new THREE.SphereGeometry(60, 32, 32);
            const planetMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true, transparent: true, opacity: 0.3 });
            planetMesh = new THREE.Mesh(planetGeo, planetMat);
            planetMesh.position.set(0, 40, -150);
            scene.add(planetMesh);

            // 3. Sao trời (Stars)
            const starGeo = new THREE.BufferGeometry();
            const starPos = [];
            for(let i=0; i<1000; i++) {
                starPos.push((Math.random()-0.5)*400, (Math.random()-0.5)*200 + 50, (Math.random()-0.5)*400 - 100);
            }
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
            stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.5}));
            scene.add(stars);

            // 4. Thành phố (Buildings) - Tạo sẵn 1 pool các tòa nhà
            const boxGeo = new THREE.BoxGeometry(5, 20, 5);
            const boxMat = new THREE.MeshNormalMaterial({ wireframe: false }); // Để tạm normal
            for(let i=0; i<40; i++) {
                const b = new THREE.Mesh(boxGeo, new THREE.MeshBasicMaterial({color: 0x222222}));
                // Thêm viền neon
                const edges = new THREE.EdgesGeometry(boxGeo);
                const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial( { color: 0xff00de } ));
                b.add(line);

                // Vị trí ngẫu nhiên 2 bên đường
                let xPos = (Math.random() > 0.5 ? 1 : -1) * (15 + Math.random() * 20);
                b.position.set(xPos, 10, -Math.random() * 300);
                b.scale.y = 0.5 + Math.random() * 2; // Cao thấp khác nhau
                scene.add(b);
                buildings.push(b);
            }
        }

        function createPlayer() {
            // Xe kiểu Cyberpunk
            const chassisGeo = new THREE.BoxGeometry(1.5, 0.5, 3);
            const chassisMat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.2 });
            player = new THREE.Mesh(chassisGeo, chassisMat);

            // Đèn đuôi (Engine)
            const engineGeo = new THREE.BoxGeometry(1.4, 0.2, 0.2);
            const engineMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
            const engine = new THREE.Mesh(engineGeo, engineMat);
            engine.position.set(0, 0, 1.5);
            player.add(engine);

            // Kính xe
            const cabinGeo = new THREE.BoxGeometry(1.0, 0.4, 1.5);
            const cabinMat = new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.9 });
            const cabin = new THREE.Mesh(cabinGeo, cabinMat);
            cabin.position.set(0, 0.5, -0.2);
            player.add(cabin);

            player.position.y = 1;
            player.castShadow = true;
            scene.add(player);
        }

        function applyLevelTheme(index) {
            const theme = LEVELS[index % LEVELS.length];
            // Cập nhật sương mù và màu nền
            scene.fog = new THREE.FogExp2(theme.fog, 0.015);
            scene.background = new THREE.Color(theme.fog);
            
            // Cập nhật màu hành tinh
            planetMesh.material.color.setHex(theme.color);
            
            // Cập nhật màu neon của tòa nhà
            buildings.forEach(b => {
                b.children[0].material.color.setHex(theme.color);
            });

            // UI
            document.getElementById('planet-display').innerText = theme.name;
            document.getElementById('planet-display').style.color = '#' + theme.color.toString(16);
        }

        // --- LOGIC GAME ---

        function startSequence() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('countdown-layer').style.display = 'block';
            
            // Đèn giao thông logic
            let count = 3;
            const text = document.getElementById('countdown-text');
            const l1 = document.getElementById('l1');
            const l2 = document.getElementById('l2');
            const l3 = document.getElementById('l3');

            const timer = setInterval(() => {
                text.innerText = count;
                if(count === 3) l1.classList.add('light-red');
                if(count === 2) l2.classList.add('light-red');
                if(count === 1) l3.classList.add('light-red');

                if(count === 0) {
                    clearInterval(timer);
                    text.innerText = "GO!";
                    text.style.color = "#0f0";
                    l1.className = "traffic-light light-green";
                    l2.className = "traffic-light light-green";
                    l3.className = "traffic-light light-green";
                    
                    setTimeout(() => {
                        document.getElementById('countdown-layer').style.display = 'none';
                        startGame();
                    }, 1000);
                }
                count--;
            }, 800);
        }

        function startGame() {
            gameActive = true;
            distanceTraveled = 0;
            speed = CONFIG.baseSpeed;
            // Xóa chướng ngại vật cũ
            obstacles.forEach(o => scene.remove(o));
            obstacles = [];
        }

        function spawnObstacle() {
            const geometry = new THREE.ConeGeometry(1, 2, 8);
            const material = new THREE.MeshStandardMaterial({ color: 0xff0055, emissive: 0xaa0022 });
            const obs = new THREE.Mesh(geometry, material);
            
            const lanes = [-CONFIG.laneWidth, 0, CONFIG.laneWidth];
            const lane = lanes[Math.floor(Math.random()*lanes.length)];
            
            obs.position.set(lane, 1, -150);
            obs.castShadow = true;
            scene.add(obs);
            obstacles.push(obs);
        }

        // --- VÒNG LẶP CHÍNH ---
        function animate() {
            requestAnimationFrame(animate);

            if(!gameActive) {
                // Hiệu ứng chờ ở menu
                renderer.render(scene, camera);
                planetMesh.rotation.y += 0.001;
                return;
            }

            // 1. Logic chuyển động
            const currentSpeed = isBoosting ? speed * 1.5 : speed;
            distanceTraveled += currentSpeed;
            
            // UI Distance
            const remaining = Math.max(0, CONFIG.levelDistance - Math.floor(distanceTraveled));
            document.getElementById('dist-remain').innerText = remaining;

            // WARP JUMP khi hết quãng đường
            if (remaining <= 0) {
                performWarpJump();
                return; // Dừng frame hiện tại để chạy warp
            }

            // Di chuyển mặt đường (texture offset)
            if(roadMesh.material.map) roadMesh.material.map.offset.y -= currentSpeed * 0.02;

            // Di chuyển tòa nhà
            buildings.forEach(b => {
                b.position.z += currentSpeed;
                if(b.position.z > 20) {
                    b.position.z = -300; // Reset về xa
                    b.scale.y = 0.5 + Math.random() * 3; // Random lại chiều cao
                }
            });

            // Hành tinh xoay
            planetMesh.rotation.y += 0.002;
            planetMesh.rotation.z += 0.001;

            // Xử lý chướng ngại vật
            if(Math.random() < 0.03) spawnObstacle();
            
            for(let i=obstacles.length-1; i>=0; i--) {
                let ob = obstacles[i];
                ob.position.z += currentSpeed;
                if(ob.position.z > 5 && ob.position.z < 8) {
                    // Check va chạm đơn giản theo làn
                    if(Math.abs(ob.position.x - player.position.x) < 1.5) {
                        gameOver();
                    }
                }
                if(ob.position.z > 20) {
                    scene.remove(ob);
                    obstacles.splice(i, 1);
                }
            }

            // Di chuyển Player (Lerp)
            player.position.x += (targetX - player.position.x) * 0.1;
            player.rotation.z = -(player.position.x - targetX) * 0.15; // Nghiêng xe
            
            // Camera follow
            camera.position.x += (player.position.x * 0.5 - camera.position.x) * 0.05;

            // Tăng tốc dần
            if(speed < CONFIG.maxSpeed) speed += 0.0005;

            renderer.render(scene, camera);
        }

        function performWarpJump() {
            gameActive = false; // Tạm dừng logic
            // Hiệu ứng màn hình trắng
            const warpScreen = document.getElementById('warp-screen');
            warpScreen.style.opacity = 1;

            setTimeout(() => {
                // Đổi Level
                levelIndex++;
                applyLevelTheme(levelIndex);
                
                // Reset vị trí
                distanceTraveled = 0;
                obstacles.forEach(o => scene.remove(o));
                obstacles = [];

                // Fade out
                warpScreen.style.opacity = 0;
                
                // Tiếp tục game
                gameActive = true;
                // Có thể tăng tốc độ cơ bản cho khó hơn
                CONFIG.baseSpeed += 0.2;
                speed = CONFIG.baseSpeed;
                
            }, 1000);
        }

        function gameOver() {
            gameActive = false;
            document.getElementById('game-over-screen').style.display = 'block';
        }

        function resetGame() {
            document.getElementById('game-over-screen').style.display = 'none';
            levelIndex = 0;
            CONFIG.baseSpeed = 0.8; // Reset độ khó
            applyLevelTheme(0);
            startSequence();
        }

        function handleInput(e) {
            if(!gameActive) return;
            if(e.code === 'ArrowLeft' || e.code === 'KeyA') {
                if(currentLane > -1) currentLane--;
            }
            if(e.code === 'ArrowRight' || e.code === 'KeyD') {
                if(currentLane < 1) currentLane++;
            }
            if(e.code === 'Space') isBoosting = true;
            targetX = currentLane * CONFIG.laneWidth;
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>